// src/app/optimizer/_lib/runeMath.ts
// Helpers de eficiÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Âªncia e grinds ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã‚Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡ÃƒÂ¯Ã‚Â¿Ã‚Â½ isolados para reuso e fÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¡cil ajuste.

export type Grind = Partial<Record<"SPD"|"HP%"|"ATK%"|"DEF%"|"ACC"|"CRI"|"CDMG"|"RES", number>>;

/** EficiÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Âªncia base estimada a partir dos subs (placeholder simples, ajuste os pesos depois). */
export function baseEfficiencyFromSubs(subs: Record<string, number>): number {
  const weights: Record<string, number> = { "SPD":2, "CRI":1.5, "CDMG":1.5, "HP%":1, "ATK%":1, "DEF%":1, "ACC":1, "RES":1 };
  let num = 0, den = 0;
  for (const [k, v] of Object.entries(subs)) {
    const w = weights[k] ?? 1;
    num += (v || 0) * w;
    den += 10 * w; // alvo teÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â³rico para normalizar; refine conforme sua fÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â³rmula real
  }
  return den ? (num/den)*100 : 0;
}

/** Retorna subs somados com grinds fornecidos. */
export function withGrinds(subs: Record<string, number>, grinds?: Grind) {
  const out = { ...subs };
  if (grinds) {
    for (const [k, g] of Object.entries(grinds)) {
      if (!g) continue;
      out[k] = (out[k] || 0) + g;
    }
  }
  return out;
}

/** EficiÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Âªncia atual e potencial (com grind). */
export function potentialEfficiency(subs: Record<string, number>, grinds?: Grind) {
  const current = baseEfficiencyFromSubs(subs);
  const maxed  = baseEfficiencyFromSubs(withGrinds(subs, grinds));
  return { current, maxed };
}
